<!doctype html>
<html>
<head>

<title>Media Sources Example</title>
<link href="node_modules/video.js/dist/video-js/video-js.css" rel="stylesheet">
<style>
  p {
    background-color: #ddd;
    border: thin solid #333;
    padding: 8px;
  }
</style>

</head>
<body>
<p>The video below is generated by passing in the bytes of an FLV directly into video.js with <a href="https://dvcs.w3.org/hg/html-media/raw-file/tip/media-source/media-source.html">Media Source Extensions</a>. Load this page up through a web server to see it in action.</p>
<video id='video' class="video-js vjs-default-skin" height="300" width="600" controls></video>

<script src="node_modules/video.js/dist/video-js/video.js"></script>
<script src="src/videojs-media-sources.js"></script>

<script>
  function str2ab(str) {
    var idx, len = str.length, arr = new Array( len );
    for ( idx = 0 ; idx < len ; ++idx ) {
        arr[ idx ] = str.charCodeAt(idx) & 0xFF;
    }
    // You may create an ArrayBuffer from a standard array (of values) as follows:
    return new Uint8Array( arr ).buffer;
  }

  // initialize video.js
  var video = videojs('video');
  // create a new media source to hold the data buffers
  var mediaSource = new videojs.MediaSource();
  // to assign a media source to a video element, you have to create a URL for it
  var url = videojs.URL.createObjectURL(mediaSource);

  // the flash-based media sources implementation only supports FLV video data
  // use XMLHttpRequest2 to get the raw byte array of an example FLV
  var req = new XMLHttpRequest();
  req.open('GET', 'barsandtone.flv', true);
  req.overrideMimeType('text\/plain; charset=x-user-defined');
  //req.responseType = 'arraybuffer';
  var sourceBuffer;
  var loadedAmount = 0;

  // when a media source is assigned to a video element the `sourceopen`
  // event fires
  mediaSource.addEventListener('sourceopen', function(event){
    // construct the video data buffer and set the appropriate MIME type
    sourceBuffer = mediaSource.addSourceBuffer('video/flv; codecs="vp6,aac"');

    // start feeding bytes to the buffer
    // the video element that is reading from the associated media buffer is
    // ready to start playing now

    req.send(null);
  }, false);

  // assign the media source URL to video.js
  video.src({
    src: url,
    type: "video/flv"
  });

  req.onreadystatechange = function(){
    var LOADING = 3;
    var FINISHED = 4;
    if (req.readyState === LOADING) {
      // wrap the arraybuffer in a view so we can easily work with the
      // individual bytes
      var bytes = str2ab(req.responseText);
      bytes = new Uint8Array(bytes);
      var totalAmount = bytes.length;
      bytes = bytes.subarray(loadedAmount);
      loadedAmount = totalAmount;

      sourceBuffer.appendBuffer(bytes);
    }
  };

</script>
</body>
</html>
